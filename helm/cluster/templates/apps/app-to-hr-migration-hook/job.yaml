{{/*
Pre-upgrade hook to safely migrate default apps from App CRs to HelmReleases.

Uses label selectors to dynamically discover all apps for this cluster,
eliminating hardcoded app lists. Handles apps from both the cluster subchart
and any provider-specific charts (e.g., cluster-aws).

Phase 1 (Pause non-bundle App CRs + WC Chart CRs):
  - Pause non-bundle App CRs to prevent app-operator from re-creating Chart CRs
  - Pause + remove finalizers + delete ALL Chart CRs on the WC
  - Bundle App CRs are NOT paused (they need active app-operator for Phase 3)

Phase 2 (Non-bundle App CRs):
  - Remove finalizers + delete App CRs with version!=0.0.0
  - This includes regular apps and bundle sub-apps

Phase 3 (Bundle App CRs via operator cascade):
  - Delete bundle App CRs (version=0.0.0, excluding operators)
  - app-operator cascade-deletes the MC Chart CRs

Flux then adopts the existing Helm releases via the new HelmRelease CRs.
*/}}
{{- if $.Values.providerIntegration.apps }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "cluster.resource.name" $ }}-migrate-apps-to-helmreleases
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "cluster.labels.common.all" $ | nindent 4 }}
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "cluster.labels.common.all" $ | nindent 8 }}
    spec:
      serviceAccountName: {{ include "cluster.resource.name" $ }}-migrate-apps
      restartPolicy: Never
      containers:
      - name: kubectl
        image: gsoci.azurecr.io/giantswarm/kubectl:{{ .Values.providerIntegration.kubernetesVersion }}
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
            - ALL
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 256Mi
        command:
        - /bin/sh
        - -c
        - |
          set -eu
          CLUSTER_NAME="{{ include "cluster.resource.name" $ }}"
          NAMESPACE="{{ $.Release.Namespace }}"
          CHART_NAMESPACE="giantswarm"

          # Fetch WC kubeconfig
          echo "Fetching WC kubeconfig for $CLUSTER_NAME"
          kubectl get secret -n "$NAMESPACE" "${CLUSTER_NAME}-kubeconfig" \
            -o jsonpath='{.data.value}' | base64 -d > /tmp/wc-kubeconfig
          WC="--kubeconfig /tmp/wc-kubeconfig"

          # ============================================================
          # Phase 1: Pause non-bundle App CRs, then clean up WC Chart CRs
          # ============================================================
          # Pause non-bundle App CRs to prevent app-operator from
          # re-creating Chart CRs after we delete them (race condition).
          # Bundle App CRs (version=0.0.0) must NOT be paused because
          # Phase 3 relies on app-operator to cascade-delete MC Chart CRs.
          echo "Phase 1a: Pausing non-bundle App CRs"

          kubectl annotate apps.application.giantswarm.io -n "$NAMESPACE" \
            -l "giantswarm.io/cluster=$CLUSTER_NAME,app-operator.giantswarm.io/version!=0.0.0" \
            "operatorkit.giantswarm.io/paused=true" --overwrite 2>/dev/null || true

          # Now clean up WC Chart CRs. Pause chart-operator reconciliation
          # to prevent it from re-adding finalizers or uninstalling Helm releases.
          echo "Phase 1b: Cleaning up ALL WC Chart CRs"

          echo "  Pausing all Chart CRs on WC"
          kubectl $WC annotate chart --all -n "$CHART_NAMESPACE" \
            "operatorkit.giantswarm.io/paused=true" --overwrite 2>/dev/null || true

          echo "  Removing finalizers from all Chart CRs on WC"
          CHARTS=$(kubectl $WC get chart -n "$CHART_NAMESPACE" \
            -o jsonpath='{.items[*].metadata.name}' 2>/dev/null) || true
          for CHART in $CHARTS; do
            kubectl $WC patch chart "$CHART" -n "$CHART_NAMESPACE" --type=json \
              -p='[{"op": "remove", "path": "/metadata/finalizers"}]' 2>/dev/null || true
          done

          echo "  Deleting all Chart CRs on WC"
          kubectl $WC delete chart --all -n "$CHART_NAMESPACE" \
            --ignore-not-found=true 2>/dev/null || true

          # ============================================================
          # Phase 2: Clean up non-bundle App CRs on MC
          # ============================================================
          # Target apps labeled with giantswarm.io/cluster but NOT
          # version=0.0.0 (which marks in-cluster/bundle apps and operators).
          # This includes regular apps and bundle sub-apps from all charts.
          # App CRs were already paused in Phase 1a.
          echo "Phase 2: Cleaning up non-bundle App CRs"

          LABEL_SELECTOR="giantswarm.io/cluster=$CLUSTER_NAME,app-operator.giantswarm.io/version!=0.0.0"

          echo "  Removing finalizers from non-bundle App CRs"
          NON_BUNDLE_APPS=$(kubectl get apps.application.giantswarm.io -n "$NAMESPACE" \
            -l "$LABEL_SELECTOR" \
            -o jsonpath='{.items[*].metadata.name}' 2>/dev/null) || true
          for APP in $NON_BUNDLE_APPS; do
            kubectl patch apps.application.giantswarm.io "$APP" -n "$NAMESPACE" --type=json \
              -p='[{"op": "remove", "path": "/metadata/finalizers"}]' 2>/dev/null || true
          done

          echo "  Deleting non-bundle App CRs"
          kubectl delete apps.application.giantswarm.io -n "$NAMESPACE" \
            -l "$LABEL_SELECTOR" \
            --ignore-not-found=true 2>/dev/null || true

          # ============================================================
          # Phase 3: Bundle App CRs via operator cascade
          # ============================================================
          # Delete bundle App CRs (version=0.0.0) without removing
          # finalizers. app-operator cascade-deletes the MC Chart CRs,
          # and chart-operator helm-uninstalls the bundles.
          # Exclude app-operator and chart-operator (must stay alive).
          echo "Phase 3: Deleting bundle App CRs (operators will clean up MC Chart CRs)"

          BUNDLE_APPS=$(kubectl get apps.application.giantswarm.io -n "$NAMESPACE" \
            -l "giantswarm.io/cluster=$CLUSTER_NAME,app-operator.giantswarm.io/version=0.0.0" \
            -o jsonpath='{.items[*].metadata.name}' 2>/dev/null) || true
          for APP in $BUNDLE_APPS; do
            case "$APP" in *-app-operator|*-chart-operator) continue ;; esac
            kubectl delete apps.application.giantswarm.io "$APP" -n "$NAMESPACE" \
              --ignore-not-found=true --wait=false 2>/dev/null || true
          done

          echo "Migration hook completed successfully"
{{- end }}
